<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2" crossorigin="anonymous"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/js/all.min.js" integrity="sha512-6PM0qYu5KExuNcKt5bURAoT6KCThUmHRewN3zUFNaoI6Di7XJPTMoT6K0nsagZKk2OB4L7E3q1uQKHNHd4stIQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<style>
  body{
    font-family: 'Kanit', sans-serif !important;
  }
</style>
</head>
<body>


<div class="card m-3">
  <div class="card-body">
    <h2 class="card-title">My locator</h2>
    <h6 class="card-title" id="name"></h6>
    <small class="text-muted" id="upt"></small>
    <div class="card-text" id="demo"><span class="fas fa-circle-notch fa-spin"></span> Loading</div>
    <div class="card mt-2">
    
      <div class="card-body">
        <table class="table table-borderless">
          <tbody>
            <tr>
              <th scope="row">Full Address<br/><button type="button" onclick="getclip()" class="btn btn-outline-primary">Copy</button></th>
              <td id="add"></td>
            </tr>
            <tr>
              <th scope="row">Coodinate</th>
              <td id="coo"></td>
            </tr>
            <tr>
              <th scope="row">Movement Speed</th>
              <td id="spd"></td>
            </tr>
            <tr>
              <th scope="row">Direction</th>
              <td id="deg"></td>
            </tr>
            <tr>
              <th scope="row">Temperature</th>
              <td id="temp"></td>
            </tr>
            <tr>
              <th scope="row">AQI Index</th>
              <td id="aqi"></td>
            </tr>
            <tr>
              <th scope="row">Air Quality (PM 2.5)</th>
              <td id="pm"></td>
            </tr>
          </tbody>
        </table>

      </div>
    </div>
    
  </div>
</div>

<script>
function AQIProcess(aqi) {
  if (aqi >= 0 && aqi <= 50) {
    return "Good"
  } else if (aqi > 50 && aqi <= 100) {
    return "Moderate"
  } else if (aqi > 100 && aqi <= 150) {
    return "Unhealty for Sensitive Groups"
  } else if (aqi > 150 && aqi <= 200) {
    return "Unhealty"
  } else if (aqi > 200 && aqi <= 300) {
    return "Very Unhealty (Damage)"
  } else if (aqi > 300) {
    return "Hazardous (Critical Zone)"
  }
}

function getclip() {
  /* Get the text field */

   /* Copy the text inside the text field */
  navigator.clipboard.writeText(document.getElementById("add").innerHTML);

  /* Alert the copied text */
  alert("Full address has been copied on your clipboard");
}

function Direction(deg) {
  if ((deg >= 0 && deg <= 22.5) && (deg > 337.5 && deg <= 359.9)) {
    return "N"
  } else if (deg > 22.5 && deg <= 67.5) {
    return "NE"
  } else if (deg > 67.5 && deg <= 112.5) {
    return "E"
  } else if (deg > 112.5 && deg <= 157.5) {
    return "SE"
  } else if (deg > 157.5 && deg <= 202.5) {
    return "S"
  } else if (deg > 202.5 && deg <= 247.5) {
    return "SW"
  } else if (deg > 247.5 && deg <= 292.5) {
    return "W"
  } else if (deg > 292.5 && deg <= 337.5) {
    return "NW"
  } else {
    return "You stopped a movement. We cannot detect direction"
  }
}

  if (window.innerWidth > 1000) {
    alert('Given coordinates may not be accurate if enabled on PC or mac OS.')
  }
  var geo = {
    lat: null,
    lon: null,
    spd: null,
    deg: NaN
    }
    var ms = 30000
  
function error(err) {
    document.getElementById("demo").innerHTML='(Please turn on your Coodinate sensor)'
}
function myFunction() {
  document.getElementById("demo").innerHTML = '<span class="fas fa-circle-notch fa-spin"></span> Loading'
	fetch('https://apiweb.cpxdev.tk/locator/getlocate?lat=' + geo.lat + '&lon='+ geo.lon, {
      method: 'POST', // or 'PUT'
      headers: {
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(req => {
        document.getElementById("demo").innerHTML = req.address[Object.keys(req.address)[0]].length  > 3 ? req.address[Object.keys(req.address)[0]] : req.address[Object.keys(req.address)[1]];
        document.getElementById("upt").innerHTML='Update in: '+new Date().toLocaleString()
        document.getElementById("add").innerHTML = req.display_name
        ms = 30000
    })
    .catch((error) => {
      console.error('Error:', error);
      document.getElementById("demo").innerHTML='Not found location'
      ms=10000
    });

    //Weather
    fetch('https://apiweb.cpxdev.tk/locator/getweather?lat=' +geo.lat+'&lon=' + geo.lon, {
      method: 'POST', // or 'PUT'
      headers: {
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(req => {
        document.getElementById("temp").innerHTML = req.current_weather.temperature + ' °C';
        document.getElementById("upt").innerHTML='Update in: '+new Date().toLocaleString()
        ms = 30000
    })
    .catch((error) => {
      console.error('Error:', error);
      document.getElementById("temp").innerHTML='Not found Weather data'
      ms=10000
    });

    //AQI
    fetch('https://apiweb.cpxdev.tk/locator/getaqi?lat='+ geo.lat+'&lon='+ geo.lon, {
      method: 'POST', // or 'PUT'
      headers: {
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(req => {
        document.getElementById("aqi").innerHTML = req.data.aqi + ' | ' + AQIProcess(req.data.aqi);
        document.getElementById("pm").innerHTML = req.data.iaqi.pm25.v + ' µg/m³';
        document.getElementById("upt").innerHTML='Update in: '+new Date().toLocaleString()
        ms = 30000
    })
    .catch((error) => {
      console.error('Error:', error);
      document.getElementById("aqi").innerHTML = 'AQI Not Found'
      document.getElementById("pm").innerHTML = 'PM2.5 Not Found'
      ms=10000
    });

    //Info
    fetch('https://apiweb.cpxdev.tk/locator/getnet', {
      method: 'POST', // or 'PUT'
      headers: {
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(req => {
        document.getElementById("name").innerHTML = req.asname.replace('-AS', '');
        ms = 30000
    })
    .catch((error) => {
      console.error('Error:', error);
      document.getElementById("name").innerHTML='Not found Network Info'
      ms=10000
    });
}
  
  function showPosition(position) {
    geo.lat = position.coords.latitude;
    geo.lon = position.coords.longitude;
    geo.spd = position.coords.speed;
    geo.deg = position.coords.heading;
}
  
if (navigator.geolocation) {
    navigator.geolocation.watchPosition(showPosition, error);
    
    var start = setInterval(function () {
      if (geo.lat != null &&  geo.lon != null) {
        clearInterval(start)
        document.getElementById("coo").innerHTML=geo.lat + ', ' + geo.lon
        myFunction()

        setInterval(function () {
            document.getElementById("coo").innerHTML=geo.lat + ', ' + geo.lon
            myFunction()
          }, ms);
          setInterval(function () {
            document.getElementById("spd").innerHTML= (geo.spd != null && geo.spd >= 1 ? (geo.spd * 3.6).toFixed(2) : '0') + ' KM/H'
            document.getElementById("deg").innerHTML= Direction(geo.deg)
          }, 500);
      }
        
      }, 1);
  }
</script>

</body>
</html>
